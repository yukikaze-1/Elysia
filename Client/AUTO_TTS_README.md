# 自动TTS功能使用说明

## 功能描述

现在已经实现了在流式聊天完成后自动调用TTS生成语音的功能。当用户进行流式聊天时，系统会：

1. **接收流式文本回复** - 正常显示服务端发来的流式文本
2. **文本完成后自动触发TTS** - 当文本接收完成后，自动调用TTS API
3. **实时语音播放** - 使用现有的WAV流式播放功能实时播放生成的语音

## 工作流程

```
用户发起流式聊天
      ↓
接收并显示流式文本
      ↓
文本接收完成 (on_text_complete)
      ↓
自动调用TTS API
      ↓
实时播放生成的语音
      ↓
播放完成，系统就绪
```

## 技术实现

### 1. NetworkHandler 新增方法
- `tts_stream_async()` - 异步TTS流式请求，调用 `/tts/generate` 接口

### 2. ElysiaClient 新增方法
- `_auto_tts_after_text_complete()` - 文本完成后自动触发TTS
- `_check_tts_status()` - 检查TTS播放状态

### 3. 修改的回调函数
- `on_text_complete()` - 增加了自动TTS触发逻辑

## 使用方式

1. **正常启动客户端**
   ```bash
   python Elysia.py
   ```

2. **发起流式聊天**
   - 点击"流式聊天"按钮
   - 输入消息并发送

3. **自动语音播放**
   - 文本接收完成后会自动开始语音生成
   - 状态栏显示"🎵 正在生成语音..."
   - 语音播放完成后显示"✅ 语音播放完成"

## 配置要求

### 服务端要求
- TTS接口可用: `http://192.168.1.17:11100/tts/generate`
- 接口格式: `POST {"text": "要转换的文本"}`
- 返回: WAV格式的流式音频数据

### 客户端要求
- 确保WAV流式播放功能正常
- pyaudio已正确安装
- 音频设备正常工作

## 状态指示

- 🎵 正在生成语音... - TTS正在处理
- ✅ 语音播放完成 - 播放成功结束
- ❌ TTS启动失败 - TTS调用失败
- ❌ TTS错误: ... - 具体错误信息

## 注意事项

1. **自动触发条件**
   - 只有在流式聊天的文本完成时才会自动触发
   - 文本内容不为空时才会调用TTS
   - 普通聊天不会自动触发TTS

2. **性能考虑**
   - TTS生成是异步进行的，不会阻塞UI
   - 使用现有的WAV流式播放机制，延迟较低
   - 支持边生成边播放，提升用户体验

3. **错误处理**
   - 网络错误会显示相应提示
   - TTS服务不可用时会降级处理
   - 音频播放异常会有错误提示

## 测试建议

1. **基础功能测试**
   - 发起流式聊天，确认文本正常接收
   - 验证文本完成后是否自动开始语音生成
   - 检查语音播放是否正常

2. **异常情况测试**
   - 断开网络连接测试错误处理
   - 发送空文本或特殊字符
   - 快速连续发送多条消息

3. **性能测试**
   - 发送长文本测试TTS处理能力
   - 测试连续聊天的响应性能
   - 验证内存和CPU使用情况
