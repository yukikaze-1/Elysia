<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysia Chat Interface</title>
    <style>
        /* --- æ ·å¼å‡çº§ç‰ˆ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f2f2f2;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        .chat-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            height: 10px; width: 10px;
            background-color: #ccc; border-radius: 50%;
            display: inline-block; margin-right: 6px;
        }
        .status-dot.connected { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .status-dot.disconnected { background-color: #f87171; }
        .status-text { font-size: 12px; font-weight: normal; opacity: 0.9; }

        /* æ¶ˆæ¯åˆ—è¡¨åŒº */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f5f7fa;
            display: flex;
            flex-direction: column;
            gap: 20px; /* æ¶ˆæ¯ç»„ä¹‹é—´çš„é—´è·å˜å¤§ */
        }

        /* --- æ ¸å¿ƒï¼šæ¶ˆæ¯è¡Œå¸ƒå±€ --- */
        .message-row {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        /* åå­—æ ‡ç­¾ */
        .message-name {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
            margin-left: 4px; /* é»˜è®¤é å·¦å¾®è°ƒ */
        }

        /* æ°”æ³¡æœ¬ä½“ */
        .message-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* === èº«ä»½å·®å¼‚åŒ–æ ·å¼ === */

        /* 1. ç”¨æˆ· (å¦–æ¢¦) - é å³ */
        .message-row.user {
            align-self: flex-end; /* æ•´ä¸ªè¡Œé å³ */
            align-items: flex-end; /* åå­—å’Œæ°”æ³¡å†…éƒ¨é å³ */
        }
        .message-row.user .message-name {
            margin-right: 4px; /* åå­—é å³å¾®è°ƒ */
        }
        .message-row.user .message-bubble {
            background-color: #95ec69; /* å¾®ä¿¡ç»¿ */
            color: #000;
            border-top-right-radius: 2px; /* æŠŠå³ä¸Šè§’å˜å°– */
        }

        /* 2. AI (Elysia) - é å·¦ */
        .message-row.ai {
            align-self: flex-start;
            align-items: flex-start;
        }
        .message-row.ai .message-bubble {
            background-color: #fff;
            color: #333;
            border-top-left-radius: 2px; /* æŠŠå·¦ä¸Šè§’å˜å°– */
        }

        /* 3. å¿ƒå£° (Elysia Inner Voice) - é å·¦ï¼Œç‰¹æ®Šæ ·å¼ */
        .message-row.inner-voice {
            align-self: flex-start;
            align-items: flex-start;
            opacity: 0.9;
        }
        .message-row.inner-voice .message-bubble {
            background-color: #f9f9f9;
            color: #555;
            font-style: italic;
            border: 1px dashed #ccc;
            font-size: 14px;
        }

        /* 4. ç³»ç»Ÿé€šçŸ¥ */
        .system-notice {
            align-self: center;
            background-color: rgba(0,0,0,0.1);
            color: #666;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 10px;
        }

        /* åº•éƒ¨è¾“å…¥åŒº */
        .chat-input-area {
            padding: 20px;
            background-color: #fff;
            border-top: 1px solid #eee;
            display: flex;
            gap: 12px;
        }
        #message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }
        #message-input:focus { border-color: #667eea; }
        #send-btn {
            padding: 0 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: bold;
        }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* æ–°å¢ï¼šè¯­éŸ³æŒ‰é’®æ ·å¼ */
        .voice-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%; /* åœ†å½¢ */
            border: 1px solid #ddd;
            background-color: #fff;
            color: #555;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤æ‰ */
        }

        .voice-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        /* æŒ‰ä½æ—¶çš„æ ·å¼ (JSé‡Œæˆ‘ä»¬è®¾ç½®äº†å˜çº¢ï¼Œè¿™é‡Œé…åˆä¸€ä¸‹) */
        .voice-btn:active {
            transform: scale(0.95); /* æŒ‰ä¸‹å¾®ç¼©æ•ˆæœ */
        }

    </style>
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">
            Elysia
            <div style="display: flex; align-items: center;">
                <span class="status-dot" id="status-dot"></span>
                <span class="status-text" id="status-text">Connecting...</span>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-box">
            </div>

        <div class="chat-input-area">
            <button id="talk-btn" class="voice-btn">ğŸ¤</button>
            <input type="text" id="message-input" placeholder="å’Œ Elysia è¯´ç‚¹ä»€ä¹ˆ..." autocomplete="off">
            <button id="send-btn" disabled>å‘é€</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        // â˜…â˜…â˜… è¯·ç¡®è®¤è¿™é‡Œçš„ IP å’Œç«¯å£ â˜…â˜…â˜…
        const WS_URL = 'ws://192.168.1.18:8000/ws'; 
        let websocket = null;

        // å½“å‰ç”¨æˆ·çš„åå­— (ç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯)
        const MY_NAME = "å¦–æ¢¦";

        // ã€ä¿®æ”¹ã€‘ä¸å†è®°å½•ç”¨æˆ·ä¸Šæ¬¡æ—¶é—´ï¼Œè€Œæ˜¯è®°å½• AI æ¶ˆæ¯åˆ°è¾¾çš„æ—¶é—´
        // åˆå§‹åŒ–ä¸ºå½“å‰æ—¶é—´ï¼Œé˜²æ­¢ç¬¬ä¸€å¥è¯æŠ¥é”™
        let lastAiMessageTimestamp = Date.now() / 1000;

        // å…¨å±€å˜é‡ï¼šå¤ç”¨åŒä¸€ä¸ªéŸ³é¢‘æµï¼Œä¸å†åå¤ç”³è¯·
        let globalStream = null;
        let mediaRecorder = null;
        let audioChunks = [];
        

        // è·å–æŒ‰é’®å…ƒç´ 
        const talkBtn = document.getElementById('talk-btn'); 

        // 1. åˆå§‹åŒ–éŸ³é¢‘æµ (åªæ‰§è¡Œä¸€æ¬¡)
        async function initAudioStream() {
            // å¦‚æœå·²ç»æœ‰æµäº†ï¼Œç›´æ¥è¿”å›ï¼Œä¸å†å¼¹çª—
            if (globalStream) return globalStream;

            try {
                // ç¬¬ä¸€æ¬¡ç”³è¯·æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                globalStream = stream;
                console.log("éº¦å…‹é£æƒé™å·²è·å–ï¼Œæµå·²ä¿æŒå¼€å¯");
                return stream;
            } catch (err) {
                console.error("æ— æ³•è·å–éº¦å…‹é£æƒé™:", err);
                alert("è¯·å…è®¸éº¦å…‹é£æƒé™ï¼Œå¦åˆ™æ— æ³•è¯­éŸ³å¯¹è¯");
                return null;
            }
        }

        // 2. æŒ‰ä¸‹æŒ‰é’®ï¼šåªè´Ÿè´£â€œå¼€å§‹å½•åˆ¶â€
        talkBtn.addEventListener('mousedown', async () => {
            const stream = await initAudioStream();
            if (!stream) return;

            // UI åé¦ˆ
            talkBtn.style.backgroundColor = "#f56565";
            talkBtn.style.transform = "scale(0.95)";

            mediaRecorder = new MediaRecorder(stream);

            // 1. å‘é€ Start
            websocket.send(JSON.stringify({
                event: "start",
                stream_type: "audio",
                meta: { role: MY_NAME, sample_rate: 48000, format: "webm" }
            }));

            // 2. ç›‘å¬æ•°æ®åˆ‡ç‰‡
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(event.data);
                }
            };

            // 3. ã€å…³é”®ä¿®æ”¹ã€‘ç›‘å¬å½•éŸ³ç»“æŸäº‹ä»¶
            // åªæœ‰å½“å½•éŸ³å™¨çœŸæ­£å®Œå…¨åœæ­¢ï¼Œå¹¶æŠŠæœ€åä¸€æ®µæ•°æ®åå‡ºæ¥ä¹‹åï¼Œ
            // è¿™é‡Œçš„ onstop æ‰ä¼šè§¦å‘ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œå‘é€ STOP æŒ‡ä»¤ã€‚
            mediaRecorder.onstop = () => {
                console.log("Recorder stopped, sending STOP signal.");
                if(websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({ event: "stop" }));
                }
            };

            mediaRecorder.start(100); 
            console.log("å½•éŸ³å¼€å§‹...");
        });

        // 4. æ¾å¼€æŒ‰é’®ï¼šåªè°ƒç”¨ stop()ï¼Œä¸è¦æ‰‹åŠ¨å‘æ¶ˆæ¯
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop(); // è¿™ä¼šè‡ªåŠ¨è§¦å‘ä¸Šé¢çš„ onstop
            }
            
            // UI æ¢å¤
            talkBtn.style.backgroundColor = ""; 
            talkBtn.style.transform = "scale(1)";
        }

        // ç»‘å®šæ¾å¼€äº‹ä»¶ (åŒæ—¶ç»‘å®šé¼ æ ‡ç§»å‡ºï¼Œé˜²æ­¢ç”¨æˆ·æŒ‰ä½ç§»å‡ºæŒ‰é’®åå¡æ­»)
        talkBtn.addEventListener('mouseup', stopRecording);
        talkBtn.addEventListener('mouseleave', stopRecording);

        function connectWebSocket() {
            websocket = new WebSocket(WS_URL);

            websocket.onopen = () => {
                updateStatus('connected');
                sendBtn.disabled = false;
                appendSystemMessage('å·²è¿æ¥åˆ° Elysia çš„å¿ƒæ™ºç©ºé—´');
            };

            websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // 1. å¤„ç†å¿ƒå£° (Inner Voice)
                    if (data.inner_voice && data.inner_voice.trim()) {
                        appendMessage('inner-voice', data.inner_voice, 'Elysia (å¿ƒå£°)');
                    }

                    // 2. å¤„ç†å¯¹è¯å†…å®¹
                    if (data.content) {
                        // â˜… å…³é”®ä¿®å¤ï¼šåˆ¤æ–­ role â˜…
                        // å¦‚æœ role æ˜¯ "å¦–æ¢¦" æˆ– "User"ï¼Œè¯´æ˜æ˜¯æœåŠ¡å™¨å›æ˜¾çš„æˆ‘çš„æ¶ˆæ¯
                        // æˆ‘ä»¬åœ¨å‘é€æ—¶å·²ç»æœ¬åœ°æ˜¾ç¤ºè¿‡äº†ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©â€œå¿½ç•¥â€ï¼Œé˜²æ­¢é‡å¤æ˜¾ç¤º
                        if (data.role === MY_NAME || data.role === 'User') {
                            console.log("å¿½ç•¥è‡ªå·±å‘é€çš„æ¶ˆæ¯å›æ˜¾");
                            return; 
                        }

                        // å¦åˆ™è®¤ä¸ºæ˜¯ Elysia çš„å›å¤
                        appendMessage('ai', data.content, 'Elysia');

                        // ã€æ–°å¢ã€‘è®°å½• AI å®Œæˆå›å¤çš„æ—¶é—´ç‚¹
                        // è¿™æ„å‘³ç€ä»è¿™ä¸€åˆ»å¼€å§‹ï¼Œè½®åˆ°ç”¨æˆ·å›åˆäº†ï¼Œè®¡æ—¶å¼€å§‹
                        lastAiMessageTimestamp = Date.now() / 1000;
                    }
                } catch (e) {
                    console.error("è§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬:", e);
                    appendMessage('ai', event.data, 'System/Raw');
                }
            };

            websocket.onclose = () => {
                updateStatus('disconnected');
                sendBtn.disabled = true;
                appendSystemMessage('è¿æ¥å·²æ–­å¼€');
            };
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !websocket) return;

            // è·å–å½“å‰æ—¶é—´æˆ³ (ç§’)
            const currentTimestamp = Date.now() / 1000;

            // è®¡ç®—ååº”å»¶è¿Ÿ
            let latency = currentTimestamp - lastAiMessageTimestamp;
            if (latency < 0) latency = 0;

            // ==========================================
            // ã€å…³é”®ä¿®æ”¹ã€‘é€‚é…æ–°çš„ StreamControlPayload æ ¼å¼
            // ==========================================
            const payload = {
                // 1. event: å¯¹åº”åç«¯ Pydantic æ¨¡å‹çš„ event å­—æ®µ
                event: "chat", 
                
                // 2. content: èŠå¤©çš„æ–‡æœ¬å†…å®¹
                content: text, 

                // 3. meta: æ‰€æœ‰çš„å…ƒæ•°æ®ï¼ˆæ—¶é—´æˆ³ã€å‘é€è€…ä¿¡æ¯ã€å»¶è¿Ÿç­‰ï¼‰éƒ½å¡è¿›è¿™é‡Œ
                meta: {
                    role: MY_NAME,   // ä½ çš„åå­—
                    timestamp: currentTimestamp,
                    latency: latency, // åˆšæ‰è®¡ç®—çš„å»¶è¿Ÿ
                    last_ai_timestamp: lastAiMessageTimestamp
                }
            };

            // 4. å‘é€ (å‘é€çš„æ˜¯ç¬¦åˆåè®®çš„ JSON)
            websocket.send(JSON.stringify(payload));

            // 5. æœ¬åœ°ç«‹å³æ˜¾ç¤º (UI é€»è¾‘ä¸å˜)
            appendMessage('user', text, MY_NAME);

            messageInput.value = '';
            messageInput.focus();
        }

        // â˜… æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šæ”¯æŒ type, text, name
        function appendMessage(type, text, senderName) {
            // åˆ›å»ºå¤–å±‚è¡Œå®¹å™¨
            const rowDiv = document.createElement('div');
            rowDiv.className = `message-row ${type}`; // type: 'user', 'ai', 'inner-voice'

            // åˆ›å»ºåå­—
            if (senderName) {
                const nameDiv = document.createElement('div');
                nameDiv.className = 'message-name';
                nameDiv.textContent = senderName;
                rowDiv.appendChild(nameDiv);
            }

            // åˆ›å»ºæ°”æ³¡
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = text;
            rowDiv.appendChild(bubbleDiv);

            chatBox.appendChild(rowDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'system-notice';
            div.textContent = text;
            chatBox.appendChild(div);
        }

        function updateStatus(status) {
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = status === 'connected' ? 'Online' : 'Offline';
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { if(e.key==='Enter') sendMessage(); });

        window.onload = () => {
            connectWebSocket();
            messageInput.focus();
        };
    </script>
</body>
</html>